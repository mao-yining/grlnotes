name: build

on:
  pull_request:
    types:
      - opened
  push:
    tags:
      - v*

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - uses: ccmaymay/setup-texlive-action@v1.0.3
        with:
          profile-path: ${{ github.workspace }}/.github/texlive.profile
          packages-path: ${{ github.workspace }}/.github/texlive.packages

      - name: Install Chinese fonts if missing
        run: |
          if ((Test-Path "$env:WINDIR\Fonts\simsun.ttc") -and (Test-Path "$env:WINDIR\Fonts\simhei.ttf")) {
              Write-Host "âœ… ä¸­æ–‡å­—ä½“å·²å­˜åœ¨"
          } else {
              Write-Host "ğŸ”„ å®‰è£…ä¸­æ–‡è¯­è¨€åŒ…..."
              Install-Language -Language zh-CN -ExcludeFeature
              Write-Host "âœ… ä¸­æ–‡è¯­è¨€åŒ…å®‰è£…å®Œæˆ"
          }
        shell: pwsh
      - name: Build PDF
        run: |
          cd src

          Copy-Item grlnotes.tex grlnotes-a4paper.tex
          $content = Get-Content grlnotes-a4paper.tex
          $content[2] = '\setmainfont{Times New Roman}'
          $content[3] = '\usepackage[a4paper]{geometry}'
          $content | Set-Content grlnotes-a4paper.tex

          latexmk -interaction=nonstopmode grlnotes-a4paper.tex

          Copy-Item grlnotes.tex grlnotes-b5paper.tex
          $content = Get-Content grlnotes-b5paper.tex
          $content[2] = '\setmainfont{Times New Roman}'
          $content[3] = '\usepackage[b5paper]{geometry}'
          $content | Set-Content grlnotes-b5paper.tex

          latexmk -interaction=nonstopmode grlnotes-b5paper.tex
        shell: pwsh

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          path: |
            src/grlnotes-b5paper.pdf
            src/grlnotes-b4paper.pdf

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          files: |
            src/grlnotes-a4paper.pdf
            src/grlnotes-b5paper.pdf
